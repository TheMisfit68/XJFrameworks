#tag Class
Protected Class JVSQLiteDatabase
Inherits SQLiteDatabase
	#tag Method, Flags = &h0
		Shared Function Create(file as FolderItem) As AutomationProjectsDbase
		  Dim database As  New AutomationProjectsDbase
		  database.databaseFile = file
		  
		  if database.createDatabaseFile then
		    
		    database.updateDbaseDiagram
		    database.fillLookupTabelSignalTypes
		    
		    return database
		    
		  else
		    
		    msgbox("[AutomationProjectsDbase] Error creating database-file  'AutomationProjectsDbase' "+database.ErrorMessage)
		    return nil
		    
		  end if
		  
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function InsertOrUpdate(tableName as String, matchFields() as String, fields as Dictionary) As Boolean
		  // Dim updateCondition as String= "KostenPlaats = '"+kostenplaats+"'"
		  // Dim updateStatement as SQLitePreparedStatement = Prepare("UPDATE Projects SET Name=?, KostenPlaats=?, Number=? WHERE "+updateCondition)
		  // updateStatement.BindType(0, SQLitePreparedStatement.SQLITE_TEXT)
		  // updateStatement.BindType(1, SQLitePreparedStatement.SQLITE_TEXT)
		  // updateStatement.BindType(2, SQLitePreparedStatement.SQLITE_TEXT)
		  // updateStatement.SQLExecute(name, kostenplaats, number)
		  // 
		  // If Error Then
		  // MsgBox("DB Error: " + ErrorMessage)
		  // Return False
		  // End If
		  // 
		  // Dim InsertStatement As SQLitePreparedStatement = Prepare("INSERT INTO Projects (Name, KostenPlaats, Number) SELECT ?, ?, ? WHERE Changes() = 0")
		  // InsertStatement.BindType(0, SQLitePreparedStatement.SQLITE_TEXT)
		  // InsertStatement.BindType(1, SQLitePreparedStatement.SQLITE_TEXT)
		  // InsertStatement.BindType(2, SQLitePreparedStatement.SQLITE_TEXT)
		  // InsertStatement.SQLExecute(name, kostenplaats, number)
		  // 
		  // If Error Then
		  // MsgBox("DB Error: " + ErrorMessage)
		  // Return False
		  // End If
		  
		  if fields.HasKey("ID") then
		    fields.Remove("ID") // Never update or insert a PK
		  end if
		  
		  dim updateFields as String = ""
		  dim insertFields as String = ""
		  for each fieldKey as Variant in fields.Keys
		    dim fieldName as String = fieldKey.StringValue
		    updateFields = updateFields + fieldName + "=?"
		    insertFields = insertFields + FieldName
		    if  fields.Keys.indexOf(fieldKey) <> fields.Keys.ubound then
		      updateFields = updateFields + ", "
		      insertFields = insertFields + ", "
		    end if
		  next
		  
		  Dim updateCondition as String =""
		  for each matchfield as String in matchFields
		    updateCondition = updateCondition+matchfield+" = '"+fields.value(matchfield)+"'"
		    if  matchfields.indexOf(matchField) <> matchfields.ubound then
		      updateCondition = updateCondition + " AND "
		    end if
		  next
		  
		  
		  Dim updateStatement as SQLitePreparedStatement = Prepare("UPDATE "+tableName+" SET "+updateFields+" WHERE "+updateCondition)
		  
		  dim fieldNumber as Integer = 0
		  for  each fieldValue as Variant in fields.Values
		    
		    select case fieldValue.type
		        case Variant.TypeInteger
		      updateStatement.BindType(fieldNumber, SQLitePreparedStatement.SQLITE_INTEGER)
		        case Variant.TypeString
		            updateStatement.BindType(fieldNumber, SQLitePreparedStatement.SQLITE_TEXT)
		        end select
		    fieldNumber = fieldNumber+1
		  next
		  
		  updateStatement.SQLExecute(fields.values)
		  
		  If Error Then
		    MsgBox("DB Error: " + ErrorMessage)
		    Return False
		  End If
		  
		  Dim InsertStatement As SQLitePreparedStatement = Prepare("INSERT INTO "+tableName+" ("+insertFields+") SELECT ?, ?, ? WHERE Changes() = 0")
		  InsertStatement.BindType(0, SQLitePreparedStatement.SQLITE_TEXT)
		  InsertStatement.BindType(1, SQLitePreparedStatement.SQLITE_TEXT)
		  InsertStatement.BindType(2, SQLitePreparedStatement.SQLITE_TEXT)
		  InsertStatement.SQLExecute(fields.values)
		  
		  If Error Then
		    MsgBox("DB Error: " + ErrorMessage)
		    Return False
		  End If
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Shared Function Open(file as FolderItem) As AutomationProjectsDbase
		  
		  If  (file <> nil) and (file.exists) Then
		    
		    // or Open
		    Dim database As New AutomationProjectsDbase
		    database.databaseFile = file
		    
		    if database.connect Then
		      database.updateDbaseDiagram
		      return database
		    else
		      msgbox("[AutomationProjectsDbase] Error connecting to database Automation Projects' "+database.ErrorMessage)
		      return nil
		    end if
		    
		  else
		    
		    // Create
		    return AutomationProjectsDbase.Create
		    
		  end if
		  
		  
		  
		  
		  
		  
		End Function
	#tag EndMethod


	#tag ViewBehavior
		#tag ViewProperty
			Name="DatabaseFile"
			Visible=true
			Type="FolderItem"
			EditorType="FolderItem"
		#tag EndViewProperty
		#tag ViewProperty
			Name="DebugMode"
			Visible=true
			Type="Boolean"
			EditorType="Boolean"
		#tag EndViewProperty
		#tag ViewProperty
			Name="EncryptionKey"
			Visible=true
			Type="String"
			EditorType="String"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Index"
			Visible=true
			Group="ID"
			Type="Integer"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Left"
			Visible=true
			Group="Position"
			Type="Integer"
		#tag EndViewProperty
		#tag ViewProperty
			Name="LoadExtensions"
			Visible=true
			Type="Boolean"
			EditorType="Boolean"
		#tag EndViewProperty
		#tag ViewProperty
			Name="MultiUser"
			Visible=true
			Type="Boolean"
			EditorType="Boolean"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Name"
			Visible=true
			Group="ID"
			Type="String"
		#tag EndViewProperty
		#tag ViewProperty
			Name="ShortColumnNames"
			Visible=true
			Type="Boolean"
			EditorType="Boolean"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Super"
			Visible=true
			Group="ID"
			Type="String"
		#tag EndViewProperty
		#tag ViewProperty
			Name="ThreadYieldInterval"
			Visible=true
			Type="Integer"
			EditorType="Integer"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Timeout"
			Visible=true
			Type="Double"
			EditorType="Double"
		#tag EndViewProperty
		#tag ViewProperty
			Name="Top"
			Visible=true
			Group="Position"
			Type="Integer"
		#tag EndViewProperty
	#tag EndViewBehavior
End Class
#tag EndClass
